# 推薦引擎設計與規則配置指南 - 營養補充品個性化推薦

## 文檔目標
本文檔旨在定義健康管理系統的**核心推薦邏輯**、**安全檢查機制**以及**規則配置方法**。確保推薦結果具有科學依據（Medical Consistency）、安全性（Safety First）與個性化（Personalization）。

---

## 一、核心引擎架構：四層過濾模型

推薦引擎採用「漏斗式」過濾結構，確保最終結果既安全又精準。

```
[用戶數據輸入: 健檢報告 + 問卷 + 基本資料]
     ↓
┌──────────────────────────────────────┐
│ 第一層：安全與禁忌過濾 (Safety Gate)   │
│ - 基於現有病史、懷孕、過敏原           │
│ - 硬性排除（Hard Exclude）             │
└──────────────────────────────────────┘
     ↓ [剩餘候選產品]
┌──────────────────────────────────────┐
│ 第二層：生理需求分析 (Scoring Engine) │
│ - 檢驗值缺陷 (Deficiencies)          │
│ - 症狀關聯 (Symptoms)                │
│ - 基礎得分計算 (Base Scores)           │
└──────────────────────────────────────┘
     ↓ [加權後的產品列表]
┌──────────────────────────────────────┐
│ 第三層：權重與優化 (Optimization)     │
│ - 生活習慣加權 (Lifestyle)            │
│ - 相互作用增益/抵銷 (Interactions)    │
│ - 優先級策略 (Priority)               │
└──────────────────────────────────────┘
     ↓ [候選清單]
┌──────────────────────────────────────┐
│ 第四層：品質控管與解釋 (Final QC)      │
│ - 是否超過每日上限 (TUL)              │
│ - 生成推薦理由 (Explainability)       │
└──────────────────────────────────────┘
     ↓
[最終推薦方案：產品 A + 產品 B + 劑量建議]
```

---

## 二、第一層：安全與禁忌規則 (Safety Gate)

### 2.1 硬性排除規則（Hard Exclusion）
直接根據用戶條件將特定類別的產品從候選清單中移除。

| 用戶標記 | 排除細分項目 | 排除理由 (對內) |
|---------|------------|---------------|
| **懷孕/哺乳** | 維生素 A (>5000 IU), 某些草本精油 | 潛在致畸或影響哺乳 |
| **腎功能異常 (eGFR < 60)** | 高劑量鉀、磷、特定草本 | 腎臟代謝負擔，易積累毒性 |
| **凝血功能異常/服用華法林** | 魚油、銀杏、維生素 E | 增加出血風險 |
| **服用降血壓藥** | 高劑量輔酶 Q10 | 可能疊加降壓效果導致低血壓 |
| **海鮮過敏** | 魚油、殼聚醣 | 過敏風險 |

### 2.2 規則代碼實現示例 (Python/JSON-like)
```python
def check_safety_gate(user_profile, candidate_products):
    excluded_categories = []
    
    if user_profile['is_pregnant']:
        excluded_categories.append('high_dose_vitamin_a')
        excluded_categories.append('unverified_herbs')
    
    if user_profile['egfr'] < 60:
        excluded_categories.append('potassium_supplements')
        excluded_categories.append('high_phosphorus')
        
    return [p for p in candidate_products if p.category not in excluded_categories]
```

---

## 三、第二層：生理需求分析與評分 (Scoring Engine)

這是核心的評分邏輯，分為「健檢指標 (Objective)」與「問卷症狀 (Subjective)」兩部分。

### 3.1 健檢指標評分矩陣 (Lab-Based)
根據檢驗值相對於參考範圍的位置給予權重。

| 檢驗指標 | 狀況 | 權重 (Priority) | 推薦營養素 | 推薦強度 |
|---------|------|----------------|----------|---------|
| **HbA1c / 血糖** | > 正常值 | 高 (High) | 鉻 (Chromium), 苦瓜勝肽 | +++ |
| **LDL / 總膽固醇** | > 正常值 | 高 (High) | 紅麴 (Monascus), 植物固醇 | +++ |
| **ALT / AST** | > 正常值 | 中 (Med) | 薑黃, 水飛薊 (Silymarin) | ++ |
| **25-OH Vitamin D**| < 30 ng/mL | 高 (High) | 維生素 D3 | ++++ |
| **Ferritin (鐵蛋白)**| < 正常值 | 高 (High) | 鐵 (Iron) + 維生素 C | +++ |

### 3.2 問卷症狀關聯 (Questionnaire-Based)
針對用戶主觀訴求進行加權。

| 用戶訴求 / 症狀 | 關聯營養素 | 加權得分 |
|--------------|----------|---------|
| 經常熬夜/容易疲勞 | 維生素 B 群, 肝精, 鋅 | +50 |
| 視力模糊/長時間用眼 | 葉黃素 (Lutein), 玉米黃素 | +40 |
| 關節疼痛/活動不便 | 葡萄糖胺, UC-II, 軟骨素 | +45 |
| 睡眠品質差/入睡困難 | 鎂 (Magnesium), GABA, 芝麻素 | +35 |

---

## 四、第三層：規則細化與相互作用

### 3.1 營養素相互作用 (Interactions)
- **增益效果 (Synergy)**：鈣 + 維生素 D（推薦度升高）。
- **抵銷效果 (Antagonism)**：鐵 + 鈣（不建議同時服用，應在不同產品或時間點）。

### 3.2 優先級計算公式
$$\text{Final Score} = \text{Base Score} \times \text{Lab Weight} + \text{Symptom Score} \times \text{Lifestyle Penalty/Bonus}$$

*註：如果某項健檢指標被標記為「危險高值」，則其對應營養素的權重直接提升 10 倍。*

---

## 五、第四層：劑量校驗與 TUL (Final QC)

### 5.1 每日總量上限檢查（保守上限 / 可配置）
產品組合的每日總量不應超過「內部保守上限」（可配置），並需由營養師/醫療顧問定期依據最新指引更新。

| 營養素 | 保守上限（可配置） | 超標後果 | 處理方式 |
|-------|--------------|---------|---------|
| 維生素 D | 2000 IU (50μg) | 高鈣血症 | 硬性截斷（Hard Cap） |
| 維生素 A | 10000 IU | 肝毒性 | 硬性截斷 |
| 鋅 | 35 mg | 影響銅吸收 | 調降建議值 |

*註：上表為示例值，用於工程守門；實際上限需依年齡、孕哺、腎肝功能、用藥狀況與最新權威資料調整。*

---

## 六、推薦理由生成邏輯 (Explainability)

系統需為每個推薦產品生成用戶可讀的理由：

- **基於健檢**：「您的**血糖**指標略高 ($HbA1c = 6.2\%$)，推薦補充**鉻**以幫助醣類代謝。」
- **基於生活型態**：「由於您有**吸菸**習慣，補充足量的**維生素 C** 可以減少氧化壓力。」
- **基於交互作用**：「建議將**鈣**與**鐵**分開服用，以確保最佳吸收率。」

---

## 七、規則配置 JSON 結構示例

為了讓營養師能彈性調整規則，後台應採用 JSON 配置：

```json
{
  "rule_id": "R_GLUCOSE_001",
  "name": "血糖高值推薦",
  "condition": {
    "field": "hba1c",
    "operator": ">",
    "value": 5.7
  },
  "recommendations": [
    {
      "nutrient_id": "chromium",
      "boost_score": 50,
      "message": "協助醣類正常代謝"
    },
    {
      "nutrient_id": "bitter_melon_extract",
      "boost_score": 30,
      "message": "植物性調節生理機能"
    }
  ],
  "safety_checks": [
    "check_hypoglycemic_meds"
  ]
}
```

---

## 八、維護與優化路徑

1. **版本控制**：所有規則配置必須有 `version_id`，以便回溯用戶在特定時間點收到的建議。
2. **人工審核 (Human-in-the-loop)**：
   - MVP 階段：AI 生成初步方案後，需經營養師在線上一鍵審核。
   - 優化階段：若系統信心值 > 0.95 且無安全隱患，可自動發送。
3. **回饋循環**：追蹤用戶服用 3-6 個月後的健檢指標變化，動態調整推薦算法。

---

**文檔版本**: v1.1  
**最後更新**: 2026-01-16  
**維護者**: 醫療團隊 / 推薦算法小組
